<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Busca de Medidores</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 400px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); box-sizing: border-box; }
        h2 { text-align: center; color: #333; margin-top: 0; }
        input { width: 100%; padding: 15px; font-size: 18px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; font-size: 16px; background-color: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:active { background-color: #c0392b; }
        ul { list-style-type: none; padding: 0; margin-top: 20px; }
        li { background: #ecf0f1; margin-bottom: 10px; padding: 15px; border-radius: 8px; font-size: 16px; color: #2c3e50; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        li:active { background: #bdc3c7; }
        .icon-map { font-size: 20px; }
        .aviso { text-align: center; color: #7f8c8d; font-size: 14px; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Buscar Medidor</h2>
        <input type="tel" id="inputMedidor" placeholder="Digite os d√≠gitos finais..." maxlength="10">
        <button id="btnLimpar">Limpar Pesquisa</button>
        <ul id="listaResultados"></ul>
        <div id="mensagemAviso" class="aviso">Conectando √† planilha... ‚è≥</div>
    </div>

    <script>
        // Link direto oficial do Google
        const LINK_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTy-YQx7XePcl-088M2dO31mTYx6aliSXNX6YFdhZ4w1Cc-U9UnUEq1VhaD9dymXIkfk3yt69F9bqU8/pub?output=csv"; 

        const input = document.getElementById('inputMedidor');
        const lista = document.getElementById('listaResultados');
        const aviso = document.getElementById('mensagemAviso');
        const btnLimpar = document.getElementById('btnLimpar');

        let bancoDeMedidores = [];

        async function carregarCSV() {
            input.disabled = true;
            try {
                // Adicionamos um n√∫mero aleat√≥rio leve s√≥ para garantir dados frescos
                const resposta = await fetch(LINK_CSV + "&v=" + Math.random());
                
                if (!resposta.ok) throw new Error("Erro no Google");

                const textoCSV = await resposta.text();
                const linhas = textoCSV.split(/\r?\n/);
                const separador = linhas[0].includes(';') ? ';' : ',';
                
                bancoDeMedidores = []; 
                
                for (let i = 1; i < linhas.length; i++) {
                    if (linhas[i].trim() === '') continue;
                    const colunas = linhas[i].split(separador);
                    if (colunas.length >= 3) {
                        bancoDeMedidores.push({
                            numero: colunas[0].trim().replace(/['"]/g, ''),
                            lat: colunas[1].trim().replace(/['"]/g, ''),
                            lng: colunas[2].trim().replace(/['"]/g, '')
                        });
                    }
                }

                aviso.textContent = `‚úÖ Banco pronto! (${bancoDeMedidores.length} medidores).`;
                input.disabled = false;
                input.focus();

            } catch (erro) {
                aviso.textContent = '‚ùå O celular bloqueou a conex√£o. O site precisa estar hospedado na internet.';
            }
        }

        carregarCSV();

        input.addEventListener('input', function(e) {
            let valor = this.value.replace(/\D/g, ''); 
            this.value = valor;
            lista.innerHTML = ''; 

            if (valor.length >= 5) {
                aviso.style.display = 'none';
                const resultados = bancoDeMedidores.filter(medidor => medidor.numero.endsWith(valor));

                if (resultados.length === 0) {
                    aviso.style.display = 'block';
                    aviso.textContent = 'Nenhum medidor encontrado com este final.';
                    return;
                }

                resultados.forEach(medidor => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>Medidor: <strong>${medidor.numero}</strong></span> <span class="icon-map">üìç</span>`;
                    li.onclick = function() {
                        const urlMaps = `https://www.google.com/maps/search/?api=1&query=${medidor.lat},${medidor.lng}`;
                        window.open(urlMaps, '_blank');
                    };
                    lista.appendChild(li);
                });
            } else {
                aviso.style.display = 'block';
                aviso.textContent = `Faltam ${5 - valor.length} d√≠gito(s) para buscar.`;
            }
        });

        btnLimpar.addEventListener('click', function() {
            input.value = '';
            lista.innerHTML = '';
            aviso.style.display = 'block';
            aviso.textContent = `‚úÖ Banco pronto! (${bancoDeMedidores.length} medidores).`;
            input.focus();
        });
    </script>
</body>
</html>
